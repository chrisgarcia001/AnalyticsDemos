#----------------------------------------------------------------------------------------------------
# Author: cgarcia
# About: This is the main script for the Yelp star prediction. The goal is to use the text reviews
#        to build a model which accurately predicts stars for new reviews whose stars are unknown.
#
#        The data used in this demo was a sample I took from the main dataset and preprocessed into 
#        a CSV file. I obtained the full Yelp dataset here: 
#        https://d396qusza40orc.cloudfront.net/dsscapstone/dataset/yelp_dataset_challenge_academic_dataset.zip
#----------------------------------------------------------------------------------------------------

library(caret)
source('classFunctions.R')
source('exploratoryFunctions.R')
source('interpretationFunctions.R')

# ------------------------ SECTION I: EXPLORATORY ANALYSIS ---------------------------------------
# This section is for initial exploratory analysis to see how high- and low-star ratings compare 
# in terms of frequent words. This section compares the frequency of different words in 1-star 
# ratings versus 5-star. This helps see if there are noticable differences in word distribution.
# ------------------------------------------------------------------------------------------------

# Read data
dstmp <- read.csv('./yelp_data/review_data_15k.csv') 

# Build comparison wordcloud: 1-star vs. 5-star
stars.compare.wordplot(dstmp, use.stars=c(1, 5), layout=c(1, 2), max.percentile=0.85) 


# ------------------------ SECTION II: MODEL PERFORMANCE ANALYSIS --------------------------------
# The section below is for the model performance analysis. If the buildModel.R file is not run, 
# this part assumes a workspace generated by that file is the current R workspace.
# ------------------------------------------------------------------------------------------------

head(build.summary.df(curr.data$testing$target.stars, stack.predictf(curr.data$testing)))

plot.results(curr.data$testing$target.stars, stack.predictf(curr.data$testing), 
			 col="yellow")

# In buildModel.R - rerun here if needed:
#raw.data <- read.csv('./yelp_data/review_data_100k.csv')		
	 
sample.size <- 500
sample.pred.data <- curr.data$testing[sample(1:nrow(curr.data$testing), sample.size),]
sample.pred.data$actual <- as.numeric(sample.pred.data$target.stars)
sample.data <- raw.data[rownames(sample.pred.data),]
sample.data$actual <- sample.pred.data$actual
sample.data$predicted <- as.numeric(stack.predictf(sample.pred.data))

# Data is already stored - rerun this if you want to come up with a 
# new random sample of predictions.
#write.csv(sample.data[,c("text", "actual", "predicted")], 
#          "./output_data/sample_predictions.csv", row.names=FALSE)

# View the comparisons - predicted vs. actual:
edit(read.csv("./output_data/sample_predictions.csv"))






			 

